<div class="space-y-8">
  <!-- Back link -->
  <div>
    <%= link_to dashboard_project_errors_path(@project), class: "inline-flex items-center gap-1.5 text-[13px] font-medium transition-colors hover:opacity-70", style: "color: #8B8780;" do %>
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back to errors
    <% end %>
  </div>

  <!-- Header -->
  <div class="flex justify-between items-start">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <span class="px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide rounded-full"
              style="<%= @error.status == 'unresolved' ? 'background: #FEEBE7; color: #CD2B31;' : @error.status == 'resolved' ? 'background: #DDF3E4; color: #18794E;' : 'background: #F0EFED; color: #6B6760;' %>">
          <%= @error.status %>
        </span>
      </div>
      <h1 class="text-[22px] font-semibold tracking-tight" style="color: #E54D2E;"><%= @error.error_class %></h1>
      <p class="text-[15px] mt-2" style="color: #6B6760;"><%= @error.message %></p>
      <% if @error.location %>
        <p class="text-[13px] mt-2 font-mono" style="color: #A19F9A;"><%= @error.location %></p>
      <% end %>
    </div>

    <div class="flex gap-2">
      <% if @selected_event %>
        <div data-controller="copy-error"
             data-copy-error-error-class-value="<%= @error.error_class %>"
             data-copy-error-message-value="<%= @error.message %>"
             data-copy-error-location-value="<%= @error.location %>"
             data-copy-error-backtrace-value="<%= @selected_event.app_backtrace.to_json %>"
             data-copy-error-request-method-value="<%= @selected_event.request_method %>"
             data-copy-error-request-path-value="<%= @selected_event.request_path %>"
             data-copy-error-params-value="<%= (@selected_event.request_params || {}).to_json %>"
             data-copy-error-context-value="<%= (@selected_event.context || {}).to_json %>"
             data-copy-error-environment-value="<%= @selected_event.environment %>"
             data-copy-error-commit-value="<%= @selected_event.commit %>">
          <button type="button" data-action="click->copy-error#copy"
                  class="px-4 py-2 text-[13px] font-medium rounded-lg transition-colors flex items-center gap-1.5 whitespace-nowrap"
                  style="background: #7C3AED; color: #FFFFFE;">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <path d="M13.3333 6H7.33333C6.59695 6 6 6.59695 6 7.33333V13.3333C6 14.0697 6.59695 14.6667 7.33333 14.6667H13.3333C14.0697 14.6667 14.6667 14.0697 14.6667 13.3333V7.33333C14.6667 6.59695 14.0697 6 13.3333 6Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3.33333 10H2.66667C2.31304 10 1.97391 9.85953 1.72386 9.60948C1.47381 9.35943 1.33333 9.0203 1.33333 8.66667V2.66667C1.33333 2.31304 1.47381 1.97391 1.72386 1.72386C1.97391 1.47381 2.31304 1.33333 2.66667 1.33333H8.66667C9.0203 1.33333 9.35943 1.47381 9.60948 1.72386C9.85953 1.97391 10 2.31304 10 2.66667V3.33333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Copy for AI
          </button>
        </div>
      <% end %>
      <% if @error.status == 'unresolved' %>
        <%= button_to 'Resolve', resolve_dashboard_project_error_path(@project, @error),
            method: :post,
            class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-colors",
            style: "background: #30A46C; color: #FFFFFE;" %>
        <%= button_to 'Ignore', ignore_dashboard_project_error_path(@project, @error),
            method: :post,
            class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-colors",
            style: "background: #F0EFED; color: #6B6760;" %>
      <% else %>
        <%= button_to 'Unresolve', unresolve_dashboard_project_error_path(@project, @error),
            method: :post,
            class: "px-4 py-2 text-[13px] font-medium rounded-lg transition-colors",
            style: "background: #F0EFED; color: #6B6760;" %>
      <% end %>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-4 gap-4">
    <div class="rounded-xl px-5 py-4" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
      <p class="text-[12px] font-medium uppercase tracking-wide" style="color: #A19F9A;">Events</p>
      <p class="text-[24px] font-semibold mt-1" style="color: #1A1A1A;"><%= @error.event_count %></p>
    </div>
    <div class="rounded-xl px-5 py-4" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
      <p class="text-[12px] font-medium uppercase tracking-wide" style="color: #A19F9A;">First seen</p>
      <p class="text-[15px] font-medium mt-1" style="color: #1A1A1A;"><%= @error.first_seen_at&.strftime('%b %d, %H:%M') || '-' %></p>
    </div>
    <div class="rounded-xl px-5 py-4" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
      <p class="text-[12px] font-medium uppercase tracking-wide" style="color: #A19F9A;">Last seen</p>
      <p class="text-[15px] font-medium mt-1" style="color: #1A1A1A;"><%= @error.last_seen_at ? "#{time_ago_in_words(@error.last_seen_at)} ago" : '-' %></p>
    </div>
    <div class="rounded-xl px-5 py-4" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
      <p class="text-[12px] font-medium uppercase tracking-wide" style="color: #A19F9A;">Commit</p>
      <p class="text-[15px] font-mono mt-1" style="color: #1A1A1A;"><%= @error.last_commit&.slice(0, 7) || '—' %></p>
    </div>
  </div>

  <!-- Event Viewer -->
  <div class="rounded-xl overflow-hidden" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
    <div class="px-5 py-4 flex items-center justify-between" style="border-bottom: 1px solid #F0EFED;">
      <h2 class="text-[14px] font-semibold" style="color: #1A1A1A;">
        Event <span style="color: #8B8780;"><%= @current_index + 1 %> of <%= @event_ids.length %></span>
      </h2>

      <!-- Event Navigation -->
      <div class="flex items-center gap-2">
        <!-- Prev button -->
        <% if @prev_event_id %>
          <%= link_to dashboard_project_error_path(@project, @error, event_id: @prev_event_id),
              class: "p-1.5 rounded-lg transition-colors hover:bg-gray-100",
              style: "color: #6B6760;" do %>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          <% end %>
        <% else %>
          <span class="p-1.5 rounded-lg" style="color: #C4C0B8;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        <% end %>

        <!-- Event selector dropdown -->
        <div class="relative" data-controller="dropdown">
          <button type="button" data-action="click->dropdown#toggle"
                  class="px-3 py-1.5 text-[13px] rounded-lg flex items-center gap-2 transition-colors hover:bg-gray-100"
                  style="background: #F7F6F4; color: #1A1A1A;">
            <span><%= @selected_event&.occurred_at&.strftime('%b %d, %H:%M:%S') %></span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="color: #8B8780;">
              <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div data-dropdown-target="menu" class="hidden absolute right-0 mt-1 w-64 rounded-lg shadow-lg z-20 max-h-64 overflow-y-auto"
               style="background: #FFFFFE; border: 1px solid #E8E5E0;">
            <% @events.each_with_index do |event, idx| %>
              <%= link_to dashboard_project_error_path(@project, @error, event_id: event.id),
                  class: "block px-3 py-2 text-[13px] transition-colors hover:bg-gray-50 #{event.id == @selected_event&.id ? 'bg-gray-50' : ''}",
                  style: "border-bottom: 1px solid #F0EFED; color: #1A1A1A;" do %>
                <div class="flex items-center justify-between">
                  <span><%= event.occurred_at.strftime('%b %d, %H:%M:%S') %></span>
                  <span class="text-[11px] px-1.5 py-0.5 rounded" style="background: #F0EFED; color: #6B6760;">
                    <%= event.environment || 'unknown' %>
                  </span>
                </div>
                <div class="text-[11px] mt-0.5" style="color: #8B8780;">
                  <%= event.user_id || 'anonymous' %> · <%= event.commit&.slice(0, 7) || 'no commit' %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>

        <!-- Next button -->
        <% if @next_event_id %>
          <%= link_to dashboard_project_error_path(@project, @error, event_id: @next_event_id),
              class: "p-1.5 rounded-lg transition-colors hover:bg-gray-100",
              style: "color: #6B6760;" do %>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          <% end %>
        <% else %>
          <span class="p-1.5 rounded-lg" style="color: #C4C0B8;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        <% end %>
      </div>
    </div>

    <% if @selected_event %>
      <div class="p-5">
        <!-- Backtrace -->
        <% if @selected_event.app_backtrace.any? %>
          <div class="rounded-lg overflow-hidden" style="background: #1A1A1A;">
            <pre class="p-4 text-[13px] font-mono overflow-x-auto" style="color: #E8E5E0;"><% @selected_event.app_backtrace.each do |frame| %><span style="color: #8B8780;"><%= frame[:file] %><%= ":#{frame[:line]}" if frame[:line] %></span><%= " in " if frame[:function] %><span style="color: #E54D2E;"><%= frame[:function] %></span>
<% end %></pre>
          </div>
        <% end %>

        <!-- Session Timeline (Breadcrumbs) -->
        <% if @selected_event.breadcrumbs.present? %>
          <div class="mt-6">
            <h3 class="text-[12px] font-semibold uppercase tracking-wide mb-4" style="color: #A19F9A;">Session Timeline</h3>
            <div class="relative">
              <!-- Timeline line -->
              <div class="absolute left-[7px] top-2 bottom-2 w-[2px]" style="background: #E8E5E0;"></div>

              <div class="space-y-3">
                <% @selected_event.breadcrumbs.each_with_index do |crumb, index| %>
                  <%
                    crumb = crumb.with_indifferent_access
                    is_error = crumb[:level] == 'error'
                    is_warning = crumb[:level] == 'warning'
                    is_last = index == @selected_event.breadcrumbs.length - 1

                    # Icon and color based on type
                    icon_color = is_error ? '#E54D2E' : is_warning ? '#F5A623' : '#30A46C'
                    bg_color = is_error ? '#FEEBE7' : is_warning ? '#FEF3E7' : '#FFFFFE'

                    # Category icon
                    category = crumb[:category] || crumb[:type]&.split('.')&.first
                  %>
                  <div class="flex gap-3 relative">
                    <!-- Timeline dot -->
                    <div class="w-4 h-4 rounded-full flex items-center justify-center z-10 flex-shrink-0 mt-0.5"
                         style="background: <%= is_error ? '#FEEBE7' : is_warning ? '#FEF3E7' : '#DDF3E4' %>; border: 2px solid <%= icon_color %>;">
                    </div>

                    <!-- Content -->
                    <div class="flex-1 rounded-lg px-3 py-2 text-[13px]" style="background: <%= bg_color %>; border: 1px solid <%= is_error ? '#FEEBE7' : is_warning ? '#FEF3E7' : '#E8E5E0' %>;">
                      <div class="flex items-center gap-2 flex-wrap">
                        <!-- Category badge -->
                        <span class="px-1.5 py-0.5 rounded text-[10px] font-medium uppercase"
                              style="background: #F0EFED; color: #6B6760;">
                          <% case category %>
                          <% when 'navigation' %>
                            ↗ nav
                          <% when 'ui' %>
                            ◉ ui
                          <% when 'http' %>
                            ⇄ http
                          <% when 'console' %>
                            ⌘ log
                          <% else %>
                            ● <%= category %>
                          <% end %>
                        </span>

                        <!-- Message -->
                        <span style="color: <%= is_error ? '#CD2B31' : '#1A1A1A' %>;">
                          <%= crumb[:message] %>
                        </span>

                        <!-- HTTP status if present -->
                        <% if crumb.dig(:data, :status_code) %>
                          <% status = crumb.dig(:data, :status_code) %>
                          <span class="px-1.5 py-0.5 rounded text-[10px] font-mono font-medium"
                                style="background: <%= status >= 400 ? '#FEEBE7' : '#DDF3E4' %>; color: <%= status >= 400 ? '#CD2B31' : '#18794E' %>;">
                            <%= status %>
                          </span>
                        <% end %>
                      </div>

                      <!-- Timestamp -->
                      <% if crumb[:timestamp] %>
                        <div class="mt-1 text-[11px]" style="color: #A19F9A;">
                          <%= Time.parse(crumb[:timestamp]).strftime('%H:%M:%S') %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <!-- Error marker -->
                <div class="flex gap-3 relative">
                  <div class="w-4 h-4 rounded-full flex items-center justify-center z-10 flex-shrink-0 mt-0.5"
                       style="background: #E54D2E;">
                    <span class="text-white text-[10px]">✕</span>
                  </div>
                  <div class="flex-1 rounded-lg px-3 py-2 text-[13px] font-medium" style="background: #FEEBE7; border: 1px solid #E54D2E; color: #CD2B31;">
                    <%= @error.error_class %>: <%= @error.short_message %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Context -->
        <div class="mt-5 grid grid-cols-2 gap-6">
          <div>
            <h3 class="text-[12px] font-semibold uppercase tracking-wide mb-3" style="color: #A19F9A;">Request</h3>
            <dl class="space-y-2 text-[14px]">
              <div class="flex gap-2">
                <dt style="color: #A19F9A;">Method</dt>
                <dd style="color: #1A1A1A;"><%= @selected_event.request_method || '-' %></dd>
              </div>
              <div class="flex gap-2">
                <dt style="color: #A19F9A;">Path</dt>
                <dd style="color: #1A1A1A;"><%= @selected_event.request_path || '-' %></dd>
              </div>
              <div class="flex gap-2">
                <dt style="color: #A19F9A;">ID</dt>
                <dd class="font-mono text-[13px]" style="color: #1A1A1A;"><%= @selected_event.request_id || '-' %></dd>
              </div>
            </dl>
          </div>

          <div>
            <h3 class="text-[12px] font-semibold uppercase tracking-wide mb-3" style="color: #A19F9A;">Context</h3>
            <dl class="space-y-2 text-[14px]">
              <div class="flex gap-2">
                <dt style="color: #A19F9A;">Environment</dt>
                <dd style="color: #1A1A1A;"><%= @selected_event.environment || '-' %></dd>
              </div>
              <div class="flex gap-2">
                <dt style="color: #A19F9A;">Commit</dt>
                <dd class="font-mono text-[13px]" style="color: #1A1A1A;"><%= @selected_event.commit&.slice(0, 7) || '-' %></dd>
              </div>
              <div class="flex gap-2">
                <dt style="color: #A19F9A;">User</dt>
                <dd style="color: #1A1A1A;"><%= @selected_event.user_id || '—' %></dd>
              </div>
            </dl>
          </div>
        </div>

        <% if @selected_event.context.present? %>
          <div class="mt-5">
            <h3 class="text-[12px] font-semibold uppercase tracking-wide mb-3" style="color: #A19F9A;">Custom context</h3>
            <pre class="rounded-lg p-4 text-[13px] font-mono overflow-x-auto" style="background: #F7F6F4;"><%= JSON.pretty_generate(@selected_event.context) %></pre>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="p-5 text-[14px]" style="color: #8B8780;">No events recorded yet.</div>
    <% end %>
  </div>

  <!-- Event History -->
  <div class="rounded-xl overflow-hidden" style="background: #FFFFFE; border: 1px solid #E8E5E0;">
    <div class="px-5 py-4" style="border-bottom: 1px solid #F0EFED;">
      <h2 class="text-[14px] font-semibold" style="color: #1A1A1A;">Recent events</h2>
    </div>

    <% if @events.any? %>
      <% @events.each_with_index do |event, index| %>
        <% is_selected = event.id == @selected_event&.id %>
        <%= link_to dashboard_project_error_path(@project, @error, event_id: event.id),
            class: "flex items-center gap-4 px-5 py-3 text-[13px] transition-colors hover:bg-gray-50",
            style: "#{index < @events.size - 1 ? 'border-bottom: 1px solid #F0EFED;' : ''} #{is_selected ? 'background: #FEF8F7;' : ''}" do %>
          <span style="color: #8B8780;"><%= event.occurred_at.strftime('%b %d, %H:%M:%S') %></span>
          <span class="px-2 py-0.5 rounded text-[11px] font-medium" style="background: #F0EFED; color: #6B6760;"><%= event.environment || 'unknown' %></span>
          <span class="font-mono text-[12px]" style="color: #A19F9A;"><%= event.commit&.slice(0, 7) %></span>
          <span style="color: #6B6760;"><%= event.user_id || 'anonymous' %></span>
          <span class="truncate" style="color: #A19F9A;"><%= event.request_path %></span>
          <% if is_selected %>
            <span class="ml-auto text-[11px] font-medium" style="color: #E54D2E;">viewing</span>
          <% end %>
        <% end %>
      <% end %>
    <% else %>
      <div class="p-5 text-[14px]" style="color: #8B8780;">No events recorded yet.</div>
    <% end %>
  </div>
</div>
